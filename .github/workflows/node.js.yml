name: Deploy Next.js to FTP Server (Portfolio Folder)
on:
  push:
    branches:
      - main # Trigger deployment on push to the main branch
jobs:
  deploy:
    name: Deploy to FTP
    runs-on: ubuntu-latest
    steps:
      # Checkout the code from your repository
      - name: Checkout code
        uses: actions/checkout@v3

      # Set up Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22.18.0'
          cache: 'npm'

      # Install dependencies and build the project
      # if you have env variables in the project add them like below so that
      # the build process wont fail
      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

      # Verify that build was successful
      - name: Verify build output
        run: |
          echo "=== Checking if .next directory exists ==="
          if [ -d ".next" ]; then
            echo "✅ .next directory found!"
            echo "=== Contents of .next ==="
            ls -la .next/
            echo "=== Checking .next/static ==="
            if [ -d ".next/static" ]; then
              echo "✅ .next/static found!"
              ls -la .next/static/ | head -10
            else
              echo "❌ ERROR: .next/static not found!"
              exit 1
            fi
          else
            echo "❌ ERROR: .next directory not found! Build may have failed."
            exit 1
          fi

      # Prepare the deployment directory
      - name: Prepare Deployment Directory
        run: |
          echo "=== Preparing deployment ==="
          rm -rf node_modules
          rm -rf .git
          echo "✅ Removed node_modules and .git"
          echo "=== Verifying .next still exists ==="
          ls -la .next/ || echo "❌ WARNING: .next was removed!"

      # Deploy files to FTP server
      - name: Deploy via FTP
        id: ftp-deploy
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        continue-on-error: true
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: app/
          exclude: |
            **/.git*
            **/node_modules
            **/.DS_Store
          dangerous-clean-slate: false
          log-level: verbose

      # Check deployment status - files may have uploaded successfully even if cleanup failed
      - name: Verify deployment status
        if: always()
        run: |
          if [ "${{ steps.ftp-deploy.outcome }}" == "failure" ]; then
            echo "⚠️ FTP deployment step encountered errors during cleanup phase."
            echo "This often happens when trying to remove non-existent directories."
            echo "If files were uploaded successfully (visible in logs above), deployment is likely valid."
            echo "Please verify your site is working correctly."
            echo ""
            echo "To fix this permanently, ensure the FTP server directory structure matches expectations."
          else
            echo "✅ Deployment completed successfully!"
          fi
